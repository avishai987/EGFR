---
title: "R Notebook"
output: 
  html_notebook: 
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

## Data
```{r}
lung = readRDS("./Data/lung_cancercells_withTP_onlyPatients.rds")
lung_patients = lung$patient.ident %>% unique() %>% as.character()
lung_patients_filtered = lung_patients[!(lung_patients %in% c("X1055new","X1099"))]
lung = subset(x = lung,subset = patient.ident %in% lung_patients_filtered)
```

```{r}
suffix ="xeno_geps"
by_expression = T #calculate metagenes by multiplie expression in genes coef, or by cnmf usage
```

```{python}
from cnmf import cNMF
suffix = r.suffix
import pickle
f = open('./Data/cnmf/cnmf_objects/patients_' + suffix + '_cnmf_obj.pckl', 'rb')
cnmf_obj = pickle.load(f)
f.close()
```
## Functions

```{r }
library(stringi)
library(reticulate)
source_from_github(repositoy = "DEG_functions",version = "0.2.24")
source_from_github(repositoy = "cNMF_functions",version = "0.3.58",script_name = "cnmf_function_Harmony.R") 
```

## K selection plot
```{r}
plot_path = paste0("/sci/labs/yotamd/lab_share/avishai.wizel/R_projects/EGFR/Data/cnmf/cNMF_patients_Varnorm_Harmony_",suffix,"/cNMF_patients_Varnorm_Harmony_",suffix,".k_selection.png")
#![K selection plot](`r plot_path` )

```


```{r}
selected_k = 3
suffix = paste(suffix,paste0(selected_k,"nmfK"),sep="_")
print(suffix)
```

```{python}
selected_k = int(r.selected_k)
density_threshold = 0.1
cnmf_obj.consensus(k=selected_k, density_threshold=density_threshold,show_clustering=True)
usage_norm, gep_scores, gep_tpm, topgenes = cnmf_obj.load_results(K=selected_k, density_threshold=density_threshold)
```



## Enrichment analysis by top 200 genes of each program
```{r fig.height=8, fig.width=8, results='hide'}
gep_scores = py$gep_scores
top_genes_num = 200
plt_list = list()
for (i in 1:ncol(gep_scores)) {
  top_genes = gep_scores  %>%  arrange(desc(gep_scores[i])) #sort by score a
  top = head(rownames(top_genes),top_genes_num) #take top top_genes_num
  res = genes_vec_enrichment(genes = top,background = rownames(gep_scores),homer = T,title = 
                    names(gep_scores)[i],silent = T,return_all = T)
   
  plt_list[[i]] = res$plt
}
gridExtra::grid.arrange(grobs = plt_list)
```



```{r}
gep_scores = py$gep_scores
cor_res = cor(gep_scores)
pheatmap(cor_res)
```

```{r}
all_top= c()
for (i in 1:ncol(gep_scores)) {
  top_genes = gep_scores  %>%  arrange(desc(gep_scores[i])) #sort by score a
  top = head(rownames(top_genes),150) #take top top_genes_num
all_top = c(all_top,top)
}
gep_scores_top = gep_scores[all_top,]
cor_res = cor(gep_scores_top)
pheatmap(cor_res)
```

```{r}
gep_scores = py$gep_scores
# groups_list = list(c(4,5,3),c(1),c(2),c(6))
groups_list = list(c(4,5,6),c(1),c(2,8),c(3),c(7),c(9))
# groups_list = list(c(4,5,7),c(1),c(2),c(3),c(7))

gep_scores = union_programs(groups_list = groups_list,all_metagenes = gep_scores)
```

```{r fig.height=8, fig.width=8, results='hide'}
top_genes_num = 200
plt_list = list()
for (i in 1:ncol(gep_scores)) {
  top_genes = gep_scores  %>%  arrange(desc(gep_scores[i])) #sort by score a
  top = head(rownames(top_genes),top_genes_num) #take top top_genes_num
  res = genes_vec_enrichment(genes = top,background = rownames(gep_scores),homer = T,title = 
                     names(gep_scores)[i],silent = T,return_all = T)
   
  plt_list[[i]] = res$plt
}
gridExtra::grid.arrange(grobs = plt_list)
```

```{r}
gep_scores = py$gep_scores
if (by_expression){
  message("calculating by expression")
  gep_scores_norm = gep_scores
    gep_scores_norm = apply(gep_scores_norm, MARGIN = 2, FUN = min_max_normalize)%>% as.data.frame()
gep_scores_norm = sum2one(gep_scores_norm)
  # gep_scores_norm = scale(gep_scores_norm) %>% as.data.frame()
  all_metagenes = expression_mult(gep_scores = gep_scores_norm,dataset = lung,top_genes = F,min_max = F,max_genes = T,z_score = F)

}else{
  message("calculating from cNMF usage")
  all_metagenes= py$usage_norm

}
```

```{r}
  # Make metagene names
  for (i in 1:ncol(all_metagenes)) {
    colnames(all_metagenes)[i] = "metagene." %>% paste0(i)
  }
```


```{r fig.height=12, fig.width=12}
#add each metagene to metadata
for (i in 1:ncol(all_metagenes)) {
  metage_metadata = all_metagenes %>% select(i)
  lung = AddMetaData(object = lung,metadata = metage_metadata)
}
FeaturePlot(object = lung,features = colnames(all_metagenes))

```













## Enrichment analysis by selecting genes using "max" method
```{r eval=FALSE, fig.height=7, fig.width=7, include=FALSE, results='hide'}
gep_scores = py$gep_scores
plt_list = list()

library(NMF)
top_features = extractFeatures(object = gep_scores %>% data.matrix(),method ="max")
for (i in 1:length(top_features)) {
  top_features[[i]]= rownames(gep_scores)[top_features[[i]]]
}

for (i in 1:ncol(gep_scores)) {
top = top_features[i] %>% unlist()
  try({ 
 res = genes_vec_enrichment(genes = top,background = rownames(gep_scores),homer = T,title = 
                    i,silent = T,return_all = T)
      plt_list[[i]] = res$plt
    }, silent=TRUE)
}
plt_list = Filter(Negate(is.null), plt_list) #remove null plots


gridExtra::grid.arrange(grobs = plt_list)

```


## Enriched in patient
```{r eval=FALSE, fig.height=5, fig.width=7, include=FALSE}
lung = SetIdent(object = lung,value = "patient.ident")
VlnPlot(object = lung,features = colnames(all_metagenes))
```
## Enriched in time point
```{r}
larger_by = 1.1
lung = program_assignment(dataset = lung,larger_by = larger_by,program_names = colnames(all_metagenes))
```   

larger_by = `r larger_by`
```{r}
cell_percentage(dataset = lung,time.point_var = "time.point")
```
## program.assignment
```{r fig.height=8, fig.width=10}
# colors =  rainbow(ncol(all_metagenes))
# fc <- colorRampPalette(c("lightgreen", "darkgreen"))
# greens = fc(4)
# colors[1] = "blue"
# colors[2:3] = greens[1:2]
# colors[4] = "red"
# colors[5:6] = greens[3:4]
# colors = c(colors,"grey")
# DimPlot(lung,group.by = "program.assignment",pt.size = 0.5,cols =colors)


# colors =  rainbow(ncol(all_metagenes))
# colors = c(colors,"grey")
# DimPlot(lung,group.by = "program.assignment",pt.size = 0.5,cols =colors)

DimPlot(lung,group.by = "program.assignment",pt.size = 0.5,cols = c("red","green","blue","grey"))
```



```{r warning=FALSE}
hallmark_name = "GO_MITOTIC_CELL_CYCLE"
genesets  =GSEABase::getGmt("./Data/h.all.v7.0.symbols.pluscc.gmt")
var_features=lung@assays$RNA@var.features
geneIds= genesets[[hallmark_name]]@geneIds
score <- apply(lung@assays$RNA@data[intersect(geneIds,var_features),],2,mean)
lung=AddMetaData(lung,score,hallmark_name)
```


```{r warning=FALSE}
FeaturePlot(object = lung,features = "metagene.3")

FeaturePlot(object = lung,features = hallmark_name)
```