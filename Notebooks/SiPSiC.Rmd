---
title: '`r rstudioapi::getSourceEditorContext()$path %>% basename() %>% gsub(pattern = "\\.Rmd",replacement = "")`' 
author: "Avishai Wizel"
date: '`r Sys.time()`'
output: 
  html_notebook: 
    code_folding: hide
    toc: yes
    toc_collapse: yes
    toc_float: 
      collapsed: FALSE
    number_sections: true
    toc_depth: 1
---

<style type="text/css">
.main-container {
  max-width: 85% !important;
  margin: auto;
}
</style>


# Functions

```{r}
library(stringi)
library(reticulate)
library(ggplotify)

source_from_github(repositoy = "DEG_functions",version = "0.2.47")
source_from_github(repositoy = "cNMF_functions",version = "0.4.04",script_name = "cnmf_functions_V3.R")
source_from_github(repositoy = "sc_general_functions",version = "0.1.34",script_name = "functions.R")


sipsic_per_patient <- function(x, dataset_splited, patients_names,to_TPM) {
  i <<- i + 1
  message(paste("pathway "), i)
  all_patients = c()
  
  for (patient in patients_names) {
    patient_data = dataset_splited[[patient]]
    if (to_TPM) {
      res = getPathwayScores((2 ^ patient_data@assays$RNA@data) - 1, unlist(x))[["pathwayScores"]]
    } else{
      res = getPathwayScores(patient_data@assays$RNA@data, unlist(x))[["pathwayScores"]]
    }
    all_patients = c(all_patients, res)
  }
  scoresAndIndices = append(scoresAndIndices, all_patients)
  
}

```

# Data

```{r}
lung = readRDS("./Data/lung_cancercells_withTP_onlyPatients.rds")
lung_patients = lung$patient.ident %>% unique() %>% as.character()
lung_patients_filtered = lung_patients[!(lung_patients %in% c("X1055new","X1099"))] # remove patients with less than 100 malignant cells
lung = subset(x = lung,subset = patient.ident %in% lung_patients_filtered)
xeno = readRDS("./Data/10x_xeno_1000.Rds")


genesets <- msigdb_download("Homo sapiens",category="H") 
hif_targets = c("LDHA", "PPFIA4", "PFKFB4", "AK4", "ERO1A", "BNIP3L", "BNIP3",  #https://pubmed.ncbi.nlm.nih.gov/36384128/
"PFKL", "ENO1", "MIR210HG", "TPI1", "HILPDA", "PGK1", "INSIG2", 
"AK4P1", "AC114803.1", "ENO2", "FUT11", "EGLN3", "NDRG1", "BNIP3P1", 
"WDR54", "OVOL1-AS1", "STC2", "DDX41", "C4orf47", "GYS1", "ANKRD37", 
"BICDL2", "P4HA1", "PDK1", "OSMR", "PKM", "LDHAP5", "AL158201.1", 
"PFKP", "MIR210", "NLRP3P1", "GSX1", "AL109946.1", "PGAM1", "SLC16A3", 
"ISM2", "TCAF2", "ARID3A", "KDM3A", "JMJD6", "C4orf3")
genesets[["HIF_targets"]] = hif_targets
```


# DE pathways

```{r}
calculatePathwayScores <- function(pathwayToScore, countsMatrix)
{
  pathwayName <- pathwayToScore@setName
  print(pathwayName)
  pathwayGenes <- pathwayToScore@geneIds
  pathwayScoresObject <- getPathwayScores(countsMatrix, pathwayGenes) 
  suppressWarnings(
    if(is.na(pathwayScoresObject)){return (NA)}
  )
  return(pathwayScoresObject$pathwayScores)
}
```

```{r}
genesets <- getGmt("./Data/msigdb_pathways/h.all.v7.0.symbols.pluscc.gmt")
genesets_cp <- getGmt("./Data/msigdb_pathways/c2.cp.v2023.2.Hs.symbols.gmt")
genesets_h_cp = GeneSetCollection(c(genesets,genesets_cp))
```

```{r}
pathwayScoreLists <- lapply(X = genesets_h_cp@.Data, calculatePathwayScores, xeno@assays$RNA@data%>% expm1())
pathwayScoreLists <- pathwayScoreLists[!is.na(pathwayScoreLists)] #remove NA pathways
pathwayScoresMatrix <- as.data.frame(do.call("rbind", pathwayScoreLists))
```

```{r}
pathwayScoresMatrix = read_rds(file = "./Data/msigdb_pathways/xeno_pathwayScoresMatrix.rds")
rownames(pathwayScoresMatrix) = names(genesets_h_cp)
xeno[["sipsic"]] = CreateAssayObject(counts = pathwayScoresMatrix)

```

```{r}
trace(Seurat:::FindMarkers.default,edit = T) #replace "bonferroni" with "fdr"

```

```{r}
xeno = SetIdent(xeno, value = "treatment")
pathways_names = gsub(names(genesets), pattern = "_", replacement = "-")


logFC_df = data.frame(row.names = pathways_names)
fdr_df = data.frame(row.names = pathways_names)

for (model in unique(xeno$orig.ident)) {
  model_data = subset(xeno, subset = orig.ident == model)
  pathway_markers = FindMarkers(
    object = model_data,
    ident.1 = "OSI",
    ident.2 = "NT",
    assay = "sipsic",
    slot = "counts",
    logfc.threshold = 0,
    densify = T,
    pseudocount.use = 0.001,
    features = pathways_names
  )
  avg_log2FC = pathway_markers[pathways_names, "avg_log2FC", drop = F]
  colnames(avg_log2FC) = model
  pathway_markers  %<>%  dplyr::rename(fdr = p_val_adj)
  fdr = pathway_markers[pathways_names, "fdr", drop = F]
  colnames(fdr) = model
  
  logFC_df = cbind(logFC_df, avg_log2FC)
  fdr_df = cbind(fdr_df, fdr)
}

fdr_df = apply(fdr_df, 1:2, \(x) format(x, digits=1)) %>% as.data.frame() #round p values 
fdr_df[fdr_df == 0] = paste0("<",format(.Machine$double.xmin,digits = 1)) # replace p=0 with p<min float
```
```{r}
untrace(Seurat:::FindMarkers.default)

```

```{r fig.height=7, fig.width=8}
col_fun = circlize::colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
ComplexHeatmap::Heatmap(logFC_df, name = "log2FC on/pre", col = col_fun,
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(fdr_df[i, j], x, y, gp = gpar(fontsize = 8))
}, row_names_gp = gpar(fontsize = 8), clustering_method_rows = "average", clustering_distance_rows = "euclidean")
```


```{r}
colors= c()
for (row_num in 1:nrow(logFC_df)) {
  row = logFC_df[row_num,]
  if (sum(row > 0.1)  >= 5) {
    colors <- c(colors, "red")
  }
  else if (sum(row < -0.1)  >= 5) {
    colors <- c(colors, "blue")
  }
  else{colors <- c(colors, "black")}
}

```

```{r fig.height=7, fig.width=8}
col_fun = circlize::colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
p = ComplexHeatmap::Heatmap(logFC_df, name = "log2FC on/pre", col = col_fun,
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(fdr_df[i, j], x, y, gp = gpar(fontsize = 8))
}, row_names_gp = gpar(fontsize = 8,col =colors), clustering_method_rows = "average", clustering_distance_rows = "euclidean")
p
```

```{r}
saveRDS(object = as.grob(p),file = "./Figures/xeno_sipsic_heatmap.rds")
```
<script src="https://hypothes.is/embed.js" async></script>

